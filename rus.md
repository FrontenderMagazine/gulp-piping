# Потоковая передача данных в стиле Gulp в Grunt или где-либо ещё

![gulp][gulp]

В последнее время довольно много внимания к себе привлёк новый инструмент для 
фронтенд разработки [Gulp][1]. Особенное изящество ему придаёт использование 
потоковой передачи данных для организации процесса сборки. Поскольку всё 
передаётся в буфер, пропадает необходимость в создании временных дисковых файлов.

Уже существует активное сообщество, которое создаёт для него плагины. Однако 
пока нет некоторых плагинов, которые мне нужны для проведения тестирования, мне 
приходится оставаться верным Grunt. Я мог бы конечно использовать Gulp и Grunt 
вместе, однако мне бы не хотелось привлекать к работе над одним проектом целых 
две системы сборки. Также в Gulp мне не нравится модель параллельного выполнения 
задач. Всё выполняется одновременно по умолчанию, что довольно неудобно когда 
вам нужно чтобы перечень задач выполнялся по порядку (как происходит по 
умолчанию в Grunt).

К счастью один из авторов Gulp переписал программный код ядра его файловой 
системы и вынес его в отдельный модуль: [`vinyl-fs`][2]. Его методы `.src()` и 
`.dest()` - это по сути всё что вам нужно для улучшения возможностей 
существующих плагинов Gulp. На момент написания этой статьи этот модуль пока не 
включён в пакетный менеджер Node, однако его можно установить воспользовавшись 
следующей записью github:

    $ npm install wearefractal/vinyl-fs

С помощью `vinyl-fs` можно легко использовать плагины Gulp в задачах Grunt:

    var fs = require('vinyl-fs'),
        gzip = require('gulp-gzip')

    grunt.registerTask('zip', function () {
      fs.src('./build/build.js')
        .pipe(gzip())
        .pipe(fs.dest('./build'))
        .on('end', this.async())
    })

Вы возможно заметили что некоторые плагины Gulp выполняют только одно простое 
действие, например переименование, добавление шапки, добавление подвала, и т.д. 
Я не против таких мелких дополнительных зависимостей, однако меня раздражает тот 
факт, что почти у всех плагинов в зависимости состоит целый модуль [event-stream][3], 
но по существу используется только функция `.map()`, доступная в отдельном 
модуле [map-stream][4]. Кроме того, что если я хочу произвести с файлом действие, 
для которого нет плагина?

Вообще то можно очень легко привести в действие некоторые такие функциональные 
возможности вручную используя `map-stream`:

    var fs = require('vinyl-fs'),
        map = require('map-stream'),
        zlib = require('zlib')
    grunt.registerTask('zip', function () {
      fs.src('./build/build.js')
        .pipe(map(gzip))
        .pipe(fs.dest('./build'))
        .on('end', this.async())
    })
    // нужно всего лишь изменить содержимое
    // файла и затем запустить функцию обратного вызова.
    // Только помните что всё сводится к добавлению и удалению из буфера.
    function gzip (file, cb) {
      zlib.gzip(file.contents, function (err, buffer) {
        file.contents = buffer
        file.path = file.path + '.gz'
        cb(err, file)
      })
    }

Такая потоковая прокачка данных позволяет делать с файлом всё что угодно: 
изменять его содержимое, название, и т.д. Радует что можно использовать прямые 
зависимости (например, `uglify-js` для задачи `uglify`) в пользовательском 
скрипте, выполнять его с помощью Grunt и всё что угодно вместо того чтобы ждать 
пока кто-то напишет для него плагин под gulp.

[1]: http://gulpjs.com/
[2]: https://github.com/wearefractal/vinyl-fs
[3]: https://github.com/dominictarr/event-stream
[4]: https://github.com/dominictarr/map-stream

[gulp]: img/gulp.png